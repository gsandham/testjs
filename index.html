<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Form.io in Business Central (iframe)</title>

  <!-- Form.io CSS -->
  <link rel="stylesheet" href="https://cdn.form.io/formiojs/formio.full.min.css">

  <style>
    body { font-family: Segoe UI, Arial, sans-serif; margin: 0; padding: 16px; }
    h2 { margin: 0 0 12px 0; }
    #log {
      margin-top: 12px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #fafafa;
      min-height: 90px;
      font-size: 13px;
      white-space: pre-wrap;
    }
  </style>

  <!-- Form.io JS -->
  <script src="https://cdn.form.io/formiojs/formio.full.min.js"></script>
</head>

<body>
  <h2>Form.io Test (running inside BC)</h2>

  <div id="formio"></div>
  <div id="log"></div>

  <script>
    let form; // make it accessible to message handlers

    function log(msg) {
      const el = document.getElementById("log");
      el.textContent += msg + "\n";
    }

    // Send a simple event to AL via the parent bridge (startup.js)
    function sendEventToAL(payload) {
      window.parent.postMessage(
        { type: "MessageFromJs", message: JSON.stringify(payload) },
        "*"
      );
    }

    // Send a request to AL (startup.js will forward to AL)
    function sendRequestToAL(action, payload) {
      const requestId = String(Date.now());
      window.parent.postMessage(
        Object.assign(
          {
            type: "BC_REQUEST",
            action: action,
            requestId: requestId
          },
          payload || {}
        ),
        "*"
      );
      return requestId;
    }

    // Build a simple Form.io form (no account needed)
    const formDef = {
      display: "form",
      components: [
        {
          type: "button",
          key: "loadFirstM",
          label: "Load first 'M' customer (from BC)",
          action: "event",
          event: "loadFirstM",
          theme: "secondary"
        },

        { type: "textfield", key: "customerNo", label: "Customer No", input: true, placeholder: "10000" },
        { type: "number", key: "amount", label: "Amount", input: true, decimalLimit: 2 },
        { type: "checkbox", key: "rush", label: "Rush?", input: true },
        { type: "textarea", key: "notes", label: "Notes", input: true },

        // NEW FIELD: Address entry
        {
          type: "textfield",
          key: "address1New",
          label: "New Address (Address 1)",
          input: true,
          placeholder: "123 Main St"
        },

        // NEW BUTTON: Update address in BC
        {
          type: "button",
          key: "updateAddress",
          label: "Update Customer Address in BC",
          action: "event",
          event: "updateAddress",
          theme: "primary"
        },

        // Optional: keep a submit-to-BC button for testing
        {
          type: "button",
          key: "submitToBC",
          label: "Submit to BC (test)",
          action: "event",
          event: "submitToBC",
          theme: "info"
        }
      ]
    };

    Formio.createForm(document.getElementById("formio"), formDef).then((f) => {
      form = f;
      log("Form.io loaded.");

      // Load first customer whose Name starts with M
      form.on("loadFirstM", () => {
        log("➡ Requesting first customer with Name starting with 'M'...");
        sendRequestToAL("GetFirstCustomerByNamePrefix", { prefix: "M" });
      });

      // Update address in BC
      form.on("updateAddress", () => {
        const data = (form.submission && form.submission.data) ? form.submission.data : {};
        const customerNo = String(data.customerNo || "").trim();
        const address1New = String(data.address1New || "").trim();

        if (!customerNo) { log("❌ Customer No is required."); return; }
        if (!address1New) { log("❌ New Address is required."); return; }

        log("➡ Requesting address update in BC...");
        sendRequestToAL("UpdateCustomerAddress", {
          customerNo: customerNo,
          address1New: address1New
        });
      });

      // Optional: Submit to BC (test)
      form.on("submitToBC", () => {
        const data = (form.submission && form.submission.data) ? form.submission.data : {};
        log("➡ Sending submit event to AL...");
        sendEventToAL({ event: "submit", data: data });
      });

      // Receive messages FROM AL (via startup.js bridge)
      window.addEventListener("message", (event) => {
        const msg = event.data || {};
        if (msg.type !== "FromAL") return;

        log("From AL: " + msg.message);

        let obj;
        try { obj = JSON.parse(msg.message); } catch { return; }

        // Prefill response
        if (obj.action === "GetFirstCustomerByNamePrefixResult") {
          if (obj.ok) {
            form.submission = {
              data: {
                customerNo: obj.customerNo || "",
                notes: obj.name || "",
                amount: 0,
                rush: false,
                address1New: ""
              }
            };
            form.redraw();
            log("✅ Prefilled customer: " + (obj.customerNo || "") + " (" + (obj.name || "") + ")");
          } else {
            log("❌ " + (obj.error || "No customer found"));
          }
          return;
        }

        // Address update response
        if (obj.action === "UpdateCustomerAddressResult") {
          if (obj.ok) {
            log("✅ Address updated for " + (obj.customerNo || "") + ": " + (obj.address1 || ""));
          } else {
            log("❌ Update failed: " + (obj.error || "Unknown error"));
          }
          return;
        }

        // Optional: generic prefill if AL sends raw JSON with matching keys
        if (obj && typeof obj === "object" && !obj.action) {
          form.submission = { data: obj };
          form.redraw();
          log("Prefilled form from AL JSON.");
        }
      });

      // Optional: tell AL we're loaded
      sendEventToAL({ event: "loaded", at: new Date().toISOString() });

    }).catch((err) => {
      log("Form.io failed to load: " + err);
    });
  </script>
</body>
</html>
